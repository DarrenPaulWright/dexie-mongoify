(function(f,e){var k={$eq:function(c,a){return function(b){return b.hasOwnProperty(c)&&b[c]===a}},$gt:function(c,a){return function(b){return b.hasOwnProperty(c)&&b[c]>a}},$gte:function(c,a){return function(b){return b.hasOwnProperty(c)&&b[c]>=a}},$lt:function(c,a){return function(b){return b.hasOwnProperty(c)&&b[c]<a}},$lte:function(c,a){return function(b){return b.hasOwnProperty(c)&&b[c]<=a}},$ne:function(c,a){return function(b){return b.hasOwnProperty(c)&&b[c]!==a}},$in:function(c,a){return function(b){return b.hasOwnProperty(c)&&
-1<a.indexOf(b[c])}},$nin:function(c,a){return function(b){return b.hasOwnProperty(c)&&-1===a.indexOf(b[c])}},$exists:function(c,a){return function(b){return b.hasOwnProperty(c)===a}},$all:function(c,a){return function(b){return b.hasOwnProperty(c)&&a.every(function(a){return-1<b[c].indexOf(a)})}},$size:function(c,a){return function(b){return b.hasOwnProperty(c)&&b[c].length===a}},$elemMatch:function(c,a){var b=m(c,a);return function(a){return a.hasOwnProperty(c)&&a[c].some(function(a){var d={};d[c]=
a;return b.every(function(b){return b(d)})})}},$not:function(c,a){var b=m(c,a);return function(a){return!a.hasOwnProperty(c)||b.every(function(b){return!b(a)})}}},n={$and:function(c,a){var b=a.map(u).reduce(e.concat);return function(a){return b.every(function(b){return b(a)})}},$or:function(c,a){var b=a.map(u);return function(a){return b.some(function(b){return b.every(function(b){return b(a)})})}},$nor:function(c,a){var b=this.$and(c,a);return function(a){return!b(a)}}},v={$inc:function(c,a){return g(a,
function(b,d){d.hasOwnProperty(b)&&(d[b]+=a[b])})},$mul:function(c,a){return g(a,function(b,d){d.hasOwnProperty(b)&&(d[b]*=a[b])})},$rename:function(c,a){return g(a,function(b,d){var c=d[b];delete d[b];d[a[b]]=c})},$set:function(c,a){return g(a,function(b,d){d[b]=a[b]})},$unset:function(c,a){return g(a,function(b,a){delete a[b]})},$min:function(c,a){return g(a,function(b,d){d[b]=Math.min(d[b],a[b])})},$max:function(c,a){return g(a,function(b,d){d[b]=Math.max(d[b],a[b])})},$addToSet:function(c,a){return g(a,
function(b,d){e.checkIsArrayField(d,b)?-1===d[b].indexOf(a[b])&&d[b].push(a[b]):d[b]=[a[b]]})},$pop:function(c,a){return g(a,function(b,d){e.checkIsArrayField(d,b);1===a[b]?d[b].pop():-1===a[b]&&d[b].shift()})},$push:function(c,a){return g(a,function(b,d){e.checkIsArrayField(d,b)?d[b].push(a[b]):d[b]=[a[b]]})},$pullAll:function(c,a){return g(a,function(b,d){e.checkIsArrayField(d,b);var c=a[b];d[b]=d[b].filter(function(b){return-1===c.indexOf(b)})})},$pull:function(c,a){return g(a,function(b,d){e.checkIsArrayField(d,
b);var c=a[b];if(e.isPlainValue(c))d[b]=d[b].filter(function(b){return b!==c});else{var l=m(b,c);d[b]=d[b].filter(function(a){var c={};c[b]=a;return!l.some(function(b){return b(c)})})}})},$slice:function(c,a){return g(a,function(b,c){e.checkIsArrayField(c,b);var h=a[b];if(e.isPlainValue(h))c[b]=e.sliceArray(c[b],h);else{var l=Object.keys(h);c[b]=c[b].map(function(b){return l.reduce(function(b,a){b[a]=e.sliceArray(b[a],h[a]);return b},b)})}})},$sort:function(c,a){return g(a,function(b,c){e.checkIsArrayField(c,
b);var h=a[b];if(e.isPlainValue(h))c[b]=c[b].sort(function(b,a){return e.valueComparator(b,a,h)});else{var l=c[b].slice();c[b]=Object.keys(h).reduce(function(b,a){var c=h[a];return l.sort(function(b,d){return e.valueComparator(b[a],d[a],c)})},c[b])}})}},w=Object.keys(k),x=Object.keys(n),y=Object.keys(v),u=function(c){return Object.keys(c).map(function(a){return m(a,c[a])}).reduce(e.concat)},m=function(c,a){return Object.keys(a).map(function(b){return p({key:c,type:b,value:a[b]})})},q=function(c,a){a=
a||Object.keys(c);return function(b){return a.every(function(a){return b.hasOwnProperty(a)&&b[a]===c[a]})}},z=function(c,a){a=a||Object.keys(c);return function(b){a.forEach(function(a){b.hasOwnProperty(a)&&(b[a]=c[a])})}},g=function(c,a){var b=Object.keys(c);return function(c){b.forEach(function(b){a(b,c)})}},A=function(c,a){var b=-1,d=-1,e=-1;a.indexedKeys.forEach(function(a,c){a.unique?b=c:"number"===typeof a.value?d=c:a.plain&&(e=c)});return-1<b?a.indexedKeys[b]:-1<d?a.indexedKeys[d]:a.indexedKeys[e]},
B=function(c){return c.queryOperators.advanced.map(function(a){return a.operators.map(function(b){return p({type:b,key:a.key,value:a.value[b]})})}).reduce(e.concat)},C=function(c){return c.updateOperators.advanced.map(function(a){return p({type:a.key,key:null,value:a.value})})},r=function(c){var a=B(c);return function(b){return a.every(function(a){return a(b)})}},D=function(c){var a=C(c);return function(b){a.forEach(function(a){a(b)})}},t=function(c){return c.queryOperators.plain.map(function(a){return a.key})},
E={primaryKey:function(c,a,b){var d=a.primaryKey.value;b=b.where(a.primaryKey.key).equals(d);0<a.queryOperators.plain.length&&(c=q(c,t(a)),b.and(c));0<a.queryOperators.advanced.length&&(a=r(a),b.and(a));return b},indexedProp:function(c,a,b){var d=A(c,a);b=d&&d.plain?b.where(d.key).equals(d.value):b.toCollection();0<a.queryOperators.plain.length&&(c=q(c,t(a)),b.and(c));0<a.queryOperators.advanced.length&&(a=r(a),b.and(a));return b},fullScan:function(c,a,b){b=b.toCollection();0<a.queryOperators.plain.length&&
(c=q(c,t(a)),b.and(c));0<a.queryOperators.advanced.length&&(a=r(a),b.and(a));return b}},F=function(c,a){var b=0<a.updateOperators.plain.length,d=0<a.updateOperators.advanced.length;if(b&&d)return function(){};if(b)return z(c,a.keys);if(d)return D(a)},p=function(c){var a;-1<w.indexOf(c.type)?a=k:-1<x.indexOf(c.type)?a=n:-1<y.indexOf(c.type)&&(a=v);return a[c.type](c.key,c.value)},G=function(c,a){return function(b,a){var h=c[a],f=e.isPlainValue(h),g=-1<x.indexOf(a);f?b.plain.push({key:a,value:h,plain:f}):
g?(g={},g[a]=h,b.advanced.push({key:a,value:g,plain:f,operators:[a]})):b.advanced.push({key:a,value:h,plain:f,operators:Object.keys(h).filter(function(b){return-1<w.indexOf(b)})});return b}},H=function(c,a){return function(b,a){var f=c[a],l=e.isPlainValue(f);l?b.plain.push({key:a,value:f,plain:l}):b.advanced.push({key:a,value:f,plain:l});return b}},I=function(c,a,b){return b.indexes.filter(function(b){return-1<a.indexOf(b.keyPath)}).map(function(b){var a=b.keyPath;return{key:a,value:c[a],unique:b.unique,
plain:e.isPlainValue(c[a])}})};f(function(c){c.addons.push(function(a){c.prototype.collection=function(b){return a.table(b)};a.Table.prototype.count=function(b){return(e.isEmptyValue(b)?this.toCollection():this.find(b)).count()};a.Table.prototype.find=function(b){if(e.isEmptyValue(b))return this.toCollection();var a;a=this.schema;var c=Object.keys(b),f=c.reduce(G(b,c),{plain:[],advanced:[]}),g=a.primKey.keyPath,k=b[g],m=typeof k;a={keys:c,queryOperators:f,primaryKey:"number"===m||"string"===m?{key:g,
value:k}:{key:!1},indexedKeys:I(b,c,a)};a={queryAnalysis:a,execute:E[a.primaryKey.key?"primaryKey":0<a.indexedKeys.length?"indexedProp":"fullScan"]};return a.execute(b,a.queryAnalysis,this)};a.Table.prototype.findOne=function(a){return this.find(a).first()};a.Table.prototype.insert=function(a){return this.add(a)};a.Table.prototype.remove=function(a){return this.find(a)["delete"]()};a.Table.prototype.drop=function(){return this.toCollection()["delete"]()};a.WriteableTable.prototype.update=function(a,
c){var f=e.isEmptyValue(a)?this.toCollection():this.find(a),g;g=Object.keys(c);g={keys:g,updateOperators:g.reduce(H(c,g),{plain:[],advanced:[]})};g=F(c,g);return f.modify(g)}})})})(function(f){"function"===typeof define&&define.amd?define(["Dexie"],function(e){f(e)}):"undefined"!==typeof global&&"undefined"!==typeof module&&module.exports?module.exports=function(e){f(e)}:f(Dexie)},{isEmptyValue:function(f){return!("object"===typeof f&&null!==f&&f)||0===Object.keys(f).length},isPlainValue:function(f){f=
typeof f;return"number"===f||"string"===f||"boolean"===f},checkIsArrayField:function(f,e){var k=f.hasOwnProperty(e),n=Array.isArray(f[e]);if(k&&!n)throw Error("You can't use array update operator on non-array field");return k},concat:function(f,e){return f.concat(e)},sliceArray:function(f,e){return 0<=e?f.slice(0,e):f.slice(e)},valueComparator:function(f,e,k){return 1===k?f>e:f<e}});
