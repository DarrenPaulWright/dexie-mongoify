(function(d,e){var k,m={$eq:function(c,b){return function(a){return a.hasOwnProperty(c)&&a[c]===b}},$gt:function(c,b){return function(a){return a.hasOwnProperty(c)&&a[c]>b}},$gte:function(c,b){return function(a){return a.hasOwnProperty(c)&&a[c]>=b}},$lt:function(c,b){return function(a){return a.hasOwnProperty(c)&&a[c]<b}},$lte:function(c,b){return function(a){return a.hasOwnProperty(c)&&a[c]<=b}},$ne:function(c,b){return function(a){return a.hasOwnProperty(c)&&a[c]!==b}},$in:function(c,b){return function(a){return a.hasOwnProperty(c)&&
-1<b.indexOf(a[c])}},$nin:function(c,b){return function(a){return a.hasOwnProperty(c)&&-1===b.indexOf(a[c])}},$exists:function(c,b){return function(a){return a.hasOwnProperty(c)===b}},$all:function(c,b){return function(a){return a.hasOwnProperty(c)&&b.every(function(b){return-1<a[c].indexOf(b)})}},$size:function(c,b){return function(a){return a.hasOwnProperty(c)&&a[c].length===b}},$elemMatch:function(c,b){var a=n(c,b);return function(b){return b.hasOwnProperty(c)&&b[c].some(function(b){var g={};g[c]=
b;return a.every(function(a){return a(g)})})}},$not:function(c,b){var a=n(c,b);return function(b){return!b.hasOwnProperty(c)||a.every(function(a){return!a(b)})}}},q={$and:function(c,b){var a=b.map(w).reduce(e.concat);return function(b){return a.every(function(a){return a(b)})}},$or:function(c,b){var a=b.map(w);return function(b){return a.some(function(a){return a.every(function(a){return a(b)})})}},$nor:function(c,b){var a=this.$and(c,b);return function(b){return!a(b)}}},x={$inc:function(c,b){return h(b,
function(a,c){c.hasOwnProperty(a)&&(c[a]+=b[a])})},$mul:function(c,b){return h(b,function(a,c){c.hasOwnProperty(a)&&(c[a]*=b[a])})},$rename:function(c,b){return h(b,function(a,c){var f=c[a];delete c[a];c[b[a]]=f})},$set:function(c,b){return h(b,function(a,c){c[a]=b[a]})},$unset:function(c,b){return h(b,function(a,b){delete b[a]})},$min:function(c,b){return h(b,function(a,c){c[a]=Math.min(c[a],b[a])})},$max:function(c,b){return h(b,function(a,c){c[a]=Math.max(c[a],b[a])})},$addToSet:function(c,b){return h(b,
function(a,c){e.checkIsArrayField(c,a)?-1===c[a].indexOf(b[a])&&c[a].push(b[a]):c[a]=[b[a]]})},$pop:function(c,b){return h(b,function(a,c){e.checkIsArrayField(c,a);1===b[a]?c[a].pop():-1===b[a]&&c[a].shift()})},$push:function(c,b){return h(b,function(a,c){e.checkIsArrayField(c,a)?c[a].push(b[a]):c[a]=[b[a]]})},$pullAll:function(c,b){return h(b,function(a,c){e.checkIsArrayField(c,a);var f=b[a];c[a]=c[a].filter(function(a){return-1===f.indexOf(a)})})},$pull:function(c,b){return h(b,function(a,c){e.checkIsArrayField(c,
a);var f=b[a];if(e.isPlainValue(f))c[a]=c[a].filter(function(a){return a!==f});else{var l=n(a,f);c[a]=c[a].filter(function(b){var c={};c[a]=b;return!l.some(function(a){return a(c)})})}})},$slice:function(c,b){return h(b,function(a,c){e.checkIsArrayField(c,a);var f=b[a];if(e.isPlainValue(f))c[a]=e.sliceArray(c[a],f);else{var l=Object.keys(f);c[a]=c[a].map(function(a){return l.reduce(function(a,b){a[b]=e.sliceArray(a[b],f[b]);return a},a)})}})},$sort:function(c,b){return h(b,function(a,c){e.checkIsArrayField(c,
a);var f=b[a];if(e.isPlainValue(f))c[a]=c[a].sort(function(a,b){return e.valueComparator(a,b,f)});else{var l=c[a].slice();c[a]=Object.keys(f).reduce(function(a,b){var c=f[b];return l.sort(function(a,g){return e.valueComparator(a[b],g[b],c)})},c[a])}})}},y=Object.keys(m),z=Object.keys(q),C=Object.keys(x),D=["upsert"],E=["$set","$addToSet","$push"],w=function(c){return Object.keys(c).map(function(b){return n(b,c[b])}).reduce(e.concat)},n=function(c,b){return Object.keys(b).map(function(a){return r({key:c,
type:a,value:b[a]})})},t=function(c,b){b=b||Object.keys(c);return function(a){return b.every(function(b){return a.hasOwnProperty(b)&&a[b]===c[b]})}},F=function(c,b){b=b||Object.keys(c);return function(a){b.forEach(function(b){a.hasOwnProperty(b)&&(a[b]=c[b])})}},h=function(c,b){var a=Object.keys(c);return function(c){a.forEach(function(a){b(a,c)})}},G=function(c,b){var a=Object.keys(c).filter(function(a){var b=m.hasOwnProperty(a);a=q.hasOwnProperty(a);return!(b||a)}).reduce(function(a,b){a[b]=c[b];
return a},{}),g=E.reduce(function(a,c){var g=b[c];g&&Object.keys(g).forEach(function(b){a[b]=g[b]});return a},{});return Object.keys(g).reduce(function(a,b){a[b]=g[b];return a},a)},H=function(c,b){var a=-1,g=-1,f=-1;b.indexedKeys.forEach(function(b,c){b.unique?a=c:"number"===typeof b.value?g=c:b.plain&&(f=c)});return-1<a?b.indexedKeys[a]:-1<g?b.indexedKeys[g]:b.indexedKeys[f]},I=function(c){return c.queryOperators.advanced.map(function(b){return b.operators.map(function(a){return r({type:a,key:b.key,
value:b.value[a]})})}).reduce(e.concat)},J=function(c){return c.updateOperators.advanced.map(function(b){return r({type:b.key,key:null,value:b.value})})},u=function(c){var b=I(c);return function(a){return b.every(function(b){return b(a)})}},K=function(c){var b=J(c);return function(a){b.forEach(function(b){b(a)})}},v=function(c){return c.queryOperators.plain.map(function(b){return b.key})},L={primaryKey:function(c,b,a){var g=b.primaryKey.value;a=a.where(b.primaryKey.key).equals(g);0<b.queryOperators.plain.length&&
(c=t(c,v(b)),a.and(c));0<b.queryOperators.advanced.length&&(b=u(b),a.and(b));return a},indexedProp:function(c,b,a){var g=H(c,b);a=g&&g.plain?a.where(g.key).equals(g.value):a.toCollection();0<b.queryOperators.plain.length&&(c=t(c,v(b)),a.and(c));0<b.queryOperators.advanced.length&&(b=u(b),a.and(b));return a},fullScan:function(c,b,a){a=a.toCollection();0<b.queryOperators.plain.length&&(c=t(c,v(b)),a.and(c));0<b.queryOperators.advanced.length&&(b=u(b),a.and(b));return a}},M=function(c,b){var a=0<b.updateOperators.plain.length,
g=0<b.updateOperators.advanced.length;if(a&&g)return function(){};if(a)return F(c,b.keys);if(g)return K(b)},N=function(c,b){return{insertedCount:1,insertedId:b.id,ops:[b.item],result:{ok:1,n:1}}},A=function(c,b){var a=b&&!0===b.isUpsert,g=a?0:c;return{result:{ok:1,nModified:g},modifiedCount:g,upsertedCount:a?1:0,upsertedId:a?b.id:null}},B=function(c){return{result:{ok:1,n:c},deletedCount:c}},O=function(c,b,a){return new k.Promise(function(g,f){c.update(b,a).then(function(f){if(0===f.modifiedCount)return f=
G(b,a),c.insert(f);g(f)}).then(function(a){"number"===typeof a.insertedId&&(a=A(1,{isUpsert:!0,id:a.insertedId}),g(a))})["catch"](f)})},Q=function(c,b,a){var g=P(a);a=M(a,g);return c.find(b).modify(a).then(function(a){return A(a,null)})},r=function(c){var b;-1<y.indexOf(c.type)?b=m:-1<z.indexOf(c.type)?b=q:-1<C.indexOf(c.type)&&(b=x);return b[c.type](c.key,c.value)},R=function(c,b){return function(a,b){var f=c[b],d=e.isPlainValue(f),h=-1<z.indexOf(b);d?a.plain.push({key:b,value:f,plain:d}):h?(h={},
h[b]=f,a.advanced.push({key:b,value:h,plain:d,operators:[b]})):a.advanced.push({key:b,value:f,plain:d,operators:Object.keys(f).filter(function(a){return-1<y.indexOf(a)})});return a}},S=function(c,b){return function(a,b){var f=c[b],d=e.isPlainValue(f);d?a.plain.push({key:b,value:f,plain:d}):a.advanced.push({key:b,value:f,plain:d});return a}},T=function(c,b,a){return a.indexes.filter(function(a){return-1<b.indexOf(a.keyPath)}).map(function(a){var b=a.keyPath;return{key:b,value:c[b],unique:a.unique,
plain:e.isPlainValue(c[b])}})},P=function(c){var b=Object.keys(c);return{keys:b,updateOperators:b.reduce(S(c,b),{plain:[],advanced:[]})}},U=function(c){return e.isEmptyValue(c)?{}:D.reduce(function(b,a){c.hasOwnProperty(a)&&(b[a]=c[a]);return b},{})},p=function(c,b){if(e.isEmptyValue(b))return c.toCollection();var a;a=c.schema;var g=Object.keys(b),f=g.reduce(R(b,g),{plain:[],advanced:[]}),d=a.primKey.keyPath,h=b[d],k=typeof h;a={keys:g,queryOperators:f,primaryKey:"number"===k||"string"===k?{key:d,
value:h}:{key:!1},indexedKeys:T(b,g,a)};a={queryAnalysis:a,execute:L[a.primaryKey.key?"primaryKey":0<a.indexedKeys.length?"indexedProp":"fullScan"]};return a.execute(b,a.queryAnalysis,c)},V=function(c,b){var a=c.schema.primKey.keyPath;return c.add(b).then(function(c){Object.keys(b).reduce(function(a,c){a[c]=b[c];return a},{})[a]=c;return N(1,{item:b,id:c})})};d(function(c){k=c;k.addons.push(function(b){k.prototype.collection=function(a){return b.table(a)};b.Table.prototype.count=function(a){return(e.isEmptyValue(a)?
this.toCollection():p(this,a)).count()};b.Table.prototype.find=function(a){return p(this,a)};b.Table.prototype.findOne=function(a){return p(this,a).first()};b.Table.prototype.insert=function(a){return V(this,a)};b.Table.prototype.remove=function(a){return p(this,a)["delete"]().then(B)};b.Table.prototype.drop=function(){return this.toCollection()["delete"]().then(B)};b.WriteableTable.prototype.update=function(a,b,c){return(!0===U(c).upsert?O:Q)(this,a,b)}})})})(function(d){"function"===typeof define&&
define.amd?define(["Dexie"],function(e){d(e)}):"undefined"!==typeof global&&"undefined"!==typeof module&&module.exports?module.exports=function(e){d(e)}:d(Dexie)},{isEmptyValue:function(d){return!("object"===typeof d&&null!==d&&d)||0===Object.keys(d).length},isPlainValue:function(d){d=typeof d;return"number"===d||"string"===d||"boolean"===d},checkIsArrayField:function(d,e){var k=d.hasOwnProperty(e),m=Array.isArray(d[e]);if(k&&!m)throw Error("You can't use array update operator on non-array field");
return k},concat:function(d,e){return d.concat(e)},sliceArray:function(d,e){return 0<=e?d.slice(0,e):d.slice(e)},valueComparator:function(d,e,k){return 1===k?d>e:d<e}});
